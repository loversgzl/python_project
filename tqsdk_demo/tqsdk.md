# 业务流程
本地 天勤 期货公司 交易所
天勤：提供接口，进行量化的地方
期货公司：帮助开账户的，只有期货公司才有资格在交易所进行交易
交易所：撮合交易的地方

```python
#TqSdk 是一个由 信易科技 发起并贡献主要代码的开源 python 库. 依托 快期多年积累成熟的交易及行情服务器体系 , TqSdk 支持用户使用很少的代码量构建各种类型的量化交易策略程序, 
# 并提供包含 历史数据-实时数据-开发调试-策略回测-模拟交易-实盘交易-运行监控-风险管理 的全套解决方案:

#信易科技（Tencent Youyun Technology Co., Ltd.）是中国腾讯旗下的一家科技公司，而其开发的天勤（Tianqin）是一款面向期货交易的综合性交易软件，而不是一个独立的期货公司。
# 天勤主要提供期货交易、行情分析、策略编写等功能，用户可以通过天勤软件连接各大期货交易所进行实盘交易。

```



# 系统架构
![image-20240219112239768](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240219112239768.png)

```python
api = TqApi(TqAccount("H海通期货", "4003242", "123456"), auth=TqAuth("快期账户", "账户密码"))      
# 创建 TqApi 实例, 指定 交易账户 和 天勤账户
#天勤账户（信易）：免费版可以绑定一个交易账户，专业版可以绑定三个交易账户
#交易账户（快期）：
问：为啥需要两个账户，一个是天勤的账户，一个是期货公司的账户，天勤应该拿到了交易所的授权可以获取行情数据，但是进行交易需要期货公司的资质，天勤不具备也没必要，
直接用现有期货公司提供的CTP期货交易柜台系统进行交互即可。


行情网关 (Open Md Gateway) 负责提供实时行情和历史数据
Open Md Gateway 是一套主要用于期货的行情服务器. 它可以接受客户端以 DIFF协议 (Differential Information Flow for Finance) 接入, 向客户端提供实时行情及历史行情数据.
按交易所规定, 行情数据只允许转发给具备相应资质, 获得交易所授权的单位. 如您是期货公司、证券公司、交易所会员或其它获得交易所授权的单位，请联系我们以获取行情服务接入URL. 如果您是个人客户, 为自己的研究或交易需要使用行情数据的，请使用我们的 天勤终端 及相应的 Python SDK
（那么天勤可能是获得交易所授权的单位，所以不需要经过期货公司授权）

交易中继网关 (Open Trade Gateway) 负责连接到期货公司交易系统：

这两个网关统一以 Diff协议 对下方提供服务

TqSdk按照Diff协议连接到行情网关和交易中继网关, 实现行情和交易功能
```


# 问：CTP-期货交易柜台系统

```
综合交易平台CTP（Comprehensive Transaction Platform）是由上海期货信息技术有限公司（上海期货交易所的全资子公司）开发的期货交易平台，CTP平台以“新一代交易所系统”的核心技术为基础，
构建了稳定、高速、开放式的接口，适合程序化交易软件运用和短线炒单客户使用。投资者可直接用CTP的API开发交易程序，连到期货公司的CTP系统交易。
CTP是一套上期所开发的系统，投资者可直接用CTP的API开发交易程序，连到期货公司的CTP系统交易。

```



# 期货交易所
```json
'SHFE（上海期货交易所）': 'SHFE',
'DCE（大连商品交易所）': 'DCE',
'CZCE（郑州商品交易所）': 'CZCE',
'CFFEX（中国金融期货交易所）': 'CFFEX',
'INE（上海能源中心(原油在这里)）': 'INE',
'KQ（快期 (所有主连合约, 指数都归属在这里)）': 'KQ',
'SSWE（上期所仓单）': 'SSWE',
'SSE（上海证券交易所）': 'SSE',
'SZSE（深圳证券交易所）': 'SZSE',
'GFEX（广州期货交易所）': 'GFEX'
```

# 问题
问：开仓数量低于最小开仓限制？如何获取期货交易所最小开仓手数？


# 基本概念

```python
#保证金
月K的平仓价close * volume * 保证金比例

# 合约的交割
如 SHFE.BU2205 合约的最后交割时刻是，22年5月15号下午三点，如果是周末或者节假日，15号顺延一天。
注意：下一个合约 SHFE.BU2305 的开始时间是，22年5月15号晚上九点开盘，因此注意，除了天勤之外，别的第三方通过别的途径拉取到交易所数据，可能会存在，2月2号晚上9点的数据，可能是2月1号的夜盘数据，就是日期和时间可能对不上，因为晚上九点算第二天的交易，它将2月1号的夜盘数据放在了2月2号


```



# 策略-数据清洗步骤

```python
# 1、下载数据
1.1、下载K线数据需要一对合约，因为需要对齐K线。

# 2、初始化文件信息
初始化文件名

# 3、清洗TICK数据
清洗过后的数据结构：（datetime，bid_price，ask_price）
慢：直接操作 dataFrame 非常的慢，一小时才处理2万条数据，五个小时才能处理10万条数据
快：先加载到内存中，再清洗，再写入到文件中保存，6min可以洗50万数据，大概可以洗掉一半的数据
1、清洗重复的tick数据：上下两个tick的ask - bid必须一样，才可以删除；
（注意：因为只比较了单边的tick上下是否相等，tick2的数据可能会影响价差，所以在计算价差的时候，需要根据两边的情况去调整，就是计算两边tick的价差，不能漏掉任何一个tick）
2、清理不在交易时间的tick数据：必须要在交易时间，早9:00-下3:00 晚9:00-晚12:00
3、清理空数据
4、和K线相关：tick数据大于K线最大值的tick也不要，58min的tick，应该小于等于55min K线的最大值。
（待验证：看301-302 和 301-303 两个K线数据的301是否一样，如果一样，其实清洗后的TICK数据是可以任意组合的）
问：一条K线的最大值，是tick的bid_price，还是 ask_price呢？？答：是bid_price，买一价，

# 4、数据预处理，计算TICK价差：以TICK1数据为主，取时间小于TICK1数据，最接近的TICK2数据，
TICK价差计算：price_diff = TICK1- TICK2
时间：保存为 TICK1 的时间

# 4、数据预处理，寻找五分钟内价差的最大最小值，加快数据的处理
数据：统计五分钟内的价差，保留最大最小值
时间段：[0, 5) 左闭右开

# 5、Kline：预处理SMA均线，标准差周期
SMA均线（windowSize）：K线价差的均值
标准差周期(groupSize)：K线价差的方差

# 5、PreKline：清理上一年K线数据
SMA均线（windowSize）：K线价差的均值
标准差周期(groupSize)：K线价差的方差

# 6、计算全局标准差

```



# 实盘交易

```python
# 实时行情
实时更新-quote表；
一天更新一次：contract_info 表



```

# 布林轨道
布林轨道计算：均值 +- N倍方差

**意义**
均值：代表了过去一段时间两个合约价差的价位
标准差：表示两个合约的相关性，相关性越好，数字越小，相关性越差，数字越大，所以更难开仓。
当没有突破上轨道：说明了什么，说明了最近一段时间这两个合约的价差本来就比较大，且相关性开始有点差了，还有没有开仓的必要，第一单是不是错了。

1、波动性指标：布林轨道的宽度随着市场波动性的增加而扩大，与市场波动性减少而缩小。当带宽扩大时，表示市场更加不稳定；带宽收窄时，表明市场稳定。

2、趋势分析：股价经常在布林带的上轨和下轨之间波动。上轨通常作为一种阻力线，而下轨作为支撑线。股价触及上轨可能表示超买状态，而触及下轨可能表示超卖状态。

3、价格目标：交易者有时会使用布林带来确定可能的价格目标。例如，如果价格从下轨反弹，交易者可能会将上轨作为潜在的上行目标。

价格异常：如果价格突破布林带的上轨或下轨，这可能是市场强劲或疲软的一个信号。尤其是价格持续在布林带之外运行，可能预示着趋势持续。

交易信号：布林轨道可以与其他指标结合使用，如相对强弱指数（RSI）、MACD等，以确认交易信号的有效性。

**如果没有突破布林轨道，说明了什么？**











